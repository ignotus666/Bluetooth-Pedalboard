This version is largely similar to the one in the main branch, but with some improvements. I may get round to documenting it some day...